<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการสารบรรณ - โรงเรียนสหราษฎร์รังสฤษดิ์</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 font-sans text-slate-900">

    <div class="flex flex-col md:flex-row min-h-screen">
        <div class="bg-slate-900 text-white w-full md:w-64 p-6 shadow-xl">
            <div class="flex items-center gap-3 mb-10">
                <div class="bg-blue-600 p-2 rounded-lg"><i class="fas fa-file-alt text-white"></i></div>
                <span class="text-lg font-bold">Admin Panel</span>
            </div>
            <nav class="space-y-1">
                <div class="text-[10px] font-bold text-slate-500 uppercase px-4 mb-2 tracking-widest">Database</div>
                <a href="#" class="flex items-center py-3 px-4 rounded-xl bg-blue-600 text-white shadow-lg shadow-blue-900/20">
                    <i class="fas fa-list-ol mr-3"></i> รายการเอกสาร
                </a>
            </nav>
        </div>

        <div class="flex-1 p-6 md:p-10 overflow-y-auto">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-black text-slate-800">จัดการฐานข้อมูล</h2>
                    <p class="text-slate-500">เรียกดูและแก้ไขข้อมูลในคอลเลกชัน <span class="badge bg-slate-200 px-2 py-0.5 rounded text-slate-700 font-mono">documents</span></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-5 py-2.5 rounded-xl hover:bg-emerald-700 transition shadow-md">
                        <i class="fas fa-file-excel mr-2"></i> ส่งออก Excel
                    </button>
                </div>
            </header>

            <div class="mb-6 relative max-w-xl">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="ค้นหาเลขที่, ชื่อเรื่อง, หรือผู้ขอ..." 
                    class="w-full pl-11 pr-4 py-3 bg-white border border-slate-200 rounded-2xl shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left" id="mainTable">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr class="text-xs font-bold text-slate-500 uppercase tracking-wider">
                                <th class="px-6 py-4">เลขที่เอกสาร</th>
                                <th class="px-6 py-4">ชื่อเรื่อง (Title)</th>
                                <th class="px-6 py-4">ผู้ขอ (Requester)</th>
                                <th class="px-6 py-4">จาก -> ถึง</th>
                                <th class="px-6 py-4 text-center">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="data-table" class="divide-y divide-slate-100 text-sm">
                            </tbody>
                    </table>
                </div>
                <div id="loader" class="py-20 text-center text-slate-400">
                    <i class="fas fa-circle-notch animate-spin text-2xl mb-2"></i>
                    <p>กำลังดึงข้อมูล...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl w-full max-w-2xl p-8 shadow-2xl">
            <h3 class="text-2xl font-bold mb-6 text-slate-800 border-b pb-4">แก้ไขข้อมูลเอกสาร</h3>
            <input type="hidden" id="edit-id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">เลขที่หนังสือ (documentNumber)</label>
                    <input type="text" id="field-docNumber" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">ผู้ขอ (Requester)</label>
                    <input type="text" id="field-requester" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">ชื่อเรื่อง (Title)</label>
                    <textarea id="field-title" rows="2" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">จาก (From)</label>
                    <input type="text" id="field-from" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">ถึง (To)</label>
                    <input type="text" id="field-to" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">หมายเหตุ (Notes)</label>
                    <input type="text" id="field-notes" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">ปี (Year)</label>
                    <input type="number" id="field-year" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <div class="mt-10 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-6 py-3 text-slate-500 font-bold">ยกเลิก</button>
                <button id="save-btn" class="px-10 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg transition">บันทึกการแก้ไข</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB33XCjD9Q8dO9Kgwc0A_qbsjYRth_pXoo",
            authDomain: "sarabunsr.firebaseapp.com",
            projectId: "sarabunsr",
            storageBucket: "sarabunsr.firebasestorage.app",
            messagingSenderId: "529273897510",
            appId: "1:529273897510:web:b385ee8c84d07613e09ce7",
            measurementId: "G-X0Q94NBCCN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "documents");

        let allData = [];

        // 1. ดึงข้อมูลแบบ Real-time ตามฟิลด์ในรูปภาพของคุณ
        onSnapshot(query(colRef, orderBy("timestamp", "desc")), (snapshot) => {
            const tableBody = document.getElementById("data-table");
            const loader = document.getElementById("loader");
            tableBody.innerHTML = "";
            loader.style.display = "none";
            allData = [];

            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;
                allData.push({ ...data, id: id });

                tableBody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                        <td class="px-6 py-5 font-bold text-blue-600">${data.documentNumber || '-'}</td>
                        <td class="px-6 py-5">
                            <div class="font-semibold text-slate-800">${data.title || '-'}</div>
                            <div class="text-[10px] text-slate-400 mt-1 uppercase tracking-tighter italic">ID: ${id}</div>
                        </td>
                        <td class="px-6 py-5 text-slate-600 font-medium">${data.requester || '-'}</td>
                        <td class="px-6 py-5 text-[11px] text-slate-500 leading-relaxed">
                            <span class="font-bold text-slate-400">จาก:</span> ${data.from || '-'}<br>
                            <span class="font-bold text-slate-400">ถึง:</span> ${data.to || '-'}
                        </td>
                        <td class="px-6 py-5 text-center whitespace-nowrap">
                            <button onclick='openEditModal(${JSON.stringify({id, ...data})})' class="w-9 h-9 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-600 hover:text-white transition shadow-sm mx-1">
                                <i class="fas fa-edit text-xs"></i>
                            </button>
                            <button onclick="deleteDocHandler('${id}')" class="w-9 h-9 bg-red-50 text-red-500 rounded-full hover:bg-red-500 hover:text-white transition shadow-sm mx-1">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        });

        // 2. ฟังก์ชันแก้ไขข้อมูล
        document.getElementById("save-btn").addEventListener("click", async () => {
            const id = document.getElementById("edit-id").value;
            const docRef = doc(db, "documents", id);
            
            const updateData = {
                documentNumber: document.getElementById("field-docNumber").value,
                title: document.getElementById("field-title").value,
                requester: document.getElementById("field-requester").value,
                from: document.getElementById("field-from").value,
                to: document.getElementById("field-to").value,
                notes: document.getElementById("field-notes").value,
                year: parseInt(document.getElementById("field-year").value)
            };

            try {
                await updateDoc(docRef, updateData);
                closeModal();
            } catch (err) { alert("เกิดข้อผิดพลาด: " + err.message); }
        });

        // 3. ฟังก์ชันลบข้อมูล
        window.deleteDocHandler = async (id) => {
            if(confirm("ยืนยันการลบข้อมูลนี้ถาวร?")) {
                await deleteDoc(doc(db, "documents", id));
            }
        };

        // UI Helpers
        window.openEditModal = (obj) => {
            document.getElementById("edit-id").value = obj.id;
            document.getElementById("field-docNumber").value = obj.documentNumber || "";
            document.getElementById("field-title").value = obj.title || "";
            document.getElementById("field-requester").value = obj.requester || "";
            document.getElementById("field-from").value = obj.from || "";
            document.getElementById("field-to").value = obj.to || "";
            document.getElementById("field-notes").value = obj.notes || "";
            document.getElementById("field-year").value = obj.year || 2025;
            document.getElementById("modal").classList.remove("hidden");
        };

        window.closeModal = () => document.getElementById("modal").classList.add("hidden");

        window.searchTable = () => {
            const input = document.getElementById("searchInput").value.toUpperCase();
            const rows = document.getElementById("data-table").getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                const text = rows[i].textContent.toUpperCase();
                rows[i].style.display = text.indexOf(input) > -1 ? "" : "none";
            }
        };

        window.exportToExcel = () => {
            const worksheet = XLSX.utils.json_to_sheet(allData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Documents");
            XLSX.writeFile(workbook, "Sarabun_Full_Database.xlsx");
        };
    </script>
</body>
</html>